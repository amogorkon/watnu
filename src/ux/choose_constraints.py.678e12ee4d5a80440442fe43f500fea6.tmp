from datetime import datetime

import numpy as np
from PyQt6 import QtGui, QtWidgets

import ui
from classes import EVERY, Every, Task


class ConstraintChooser(QtWidgets.QDialog, ui.choose_constraints.Ui_Dialog):
    def __init__(self, editor, task: Task = None):
        super().__init__()
        self.setupUi(self)
        self.editor = editor
        self.table.horizontalHeader().setHighlightSections(False)
        for i, (hour, part) in enumerate((hour, part) for hour in range(24) for part in range(12)):
            item = QtWidgets.QTableWidgetItem(f"{hour}: {part}0-{part}4")
            if i % 6 == 0:
                font = QtGui.QFont()
                font.setItalic(True)
                font.setWeight(90)
                item.setFont(font)
            self.table.setVerticalHeaderItem(i, item)
        for column, day in enumerate(editor.constraints):
            for row, value in enumerate(day):
                if value:
                    self.table.setCurrentCell(row, column)

        @self.buttonBox.button(QtWidgets.QDialogButtonBox.StandardButton.Reset).clicked.connect
        def reset():
            self.table.clearSelection()

        @self.buttonBox.button(QtWidgets.QDialogButtonBox.StandardButton.Discard).clicked.connect
        def discard():
            self.editor.constraints = None
            self.close()

    def accept(self):
        super().accept()
        A = np.zeros(2016, int)
        A[[idx.column() * 144 + idx.row() for idx in self.table.selectedIndexes()]] = 1
        self.editor.constraints = A.reshape(7, 288)
